# YOP .NET SDK 代码规范统一方案

## 概述

本文档制定了YOP .NET SDK项目的代码规范统一方案，旨在提升代码质量、可维护性和团队协作效率。

## 代码风格规范

### 1. 命名约定

#### 1.1 类和接口
```csharp
// 类名：PascalCase
public class YopClient
public class AesEncrypter

// 接口名：PascalCase，以I开头
public interface IEncryptor
public interface IYopService
```

#### 1.2 方法和属性
```csharp
// 方法名：PascalCase
public static YopResponse Post(string methodOrUri, YopRequest request)
public string GetSecretKey()

// 属性名：PascalCase
public string AppKey { get; set; }
public bool IsValid { get; }
```

#### 1.3 变量和字段
```csharp
// 私有字段：camelCase，可选_前缀
private static string _serverRoot;
private readonly HttpClient _httpClient;

// 局部变量：camelCase
var request = new YopRequest();
string result = ProcessData();
```

#### 1.4 常量和枚举
```csharp
// 常量：PascalCase
public const string DEFAULT_ENCODING = "UTF-8";

// 枚举：PascalCase
public enum FormatType
{
    Json,
    Xml
}
```

### 2. 文件组织

#### 2.1 文件命名
- 类文件：类名.cs（如 `YopClient.cs`）
- 接口文件：接口名.cs（如 `IEncryptor.cs`）
- 枚举文件：枚举名.cs（如 `FormatType.cs`）

#### 2.2 文件结构
```csharp
// 1. using语句（按字母顺序）
using System;
using System.Collections.Generic;
using System.Text;

// 2. 命名空间
namespace SDK.Yop.Client
{
    // 3. 类/接口定义
    public class YopClient
    {
        // 4. 字段（静态字段、实例字段）
        private static readonly HttpClient _httpClient;
        
        // 5. 属性
        public string AppKey { get; set; }
        
        // 6. 构造函数
        public YopClient()
        {
        }
        
        // 7. 方法（按访问级别：public -> protected -> private）
        public static YopResponse Post(string methodOrUri, YopRequest request)
        {
        }
        
        private void ValidateRequest(YopRequest request)
        {
        }
    }
}
```

### 3. 代码格式化

#### 3.1 缩进和空格
- 使用4个空格缩进（不使用Tab）
- 运算符前后添加空格
- 逗号后添加空格

```csharp
// 正确示例
if (condition)
{
    var result = a + b, c = d;
}

// 错误示例
if(condition){
var result=a+b,c=d;
}
```

#### 3.2 大括号
- 左大括号换行
- 即使单行语句也使用大括号

```csharp
// 正确示例
if (condition)
{
    DoSomething();
}

// 错误示例
if (condition) DoSomething();
```

#### 3.3 行长度
- 每行最多120个字符
- 超长时合理换行

```csharp
// 正确示例
var result = SomeVeryLongMethodName(parameter1, parameter2, 
    parameter3, parameter4);

// 错误示例
var result = SomeVeryLongMethodName(parameter1, parameter2, parameter3, parameter4);
```

## 注释和文档规范

### 1. XML文档注释

#### 1.1 公共API注释
```csharp
/// <summary>
/// 发起POST请求到指定的API端点
/// </summary>
/// <param name="methodOrUri">API方法名称或REST URI</param>
/// <param name="request">请求对象，包含所有必要的参数</param>
/// <returns>包含响应数据的YopResponse对象</returns>
/// <exception cref="ArgumentNullException">当methodOrUri或request为null时抛出</exception>
/// <exception cref="YopClientException">当请求失败时抛出</exception>
/// <example>
/// <code>
/// var request = new YopRequest();
/// request.AddParam("orderNo", "123456");
/// var response = YopClient.Post("rest/v1.0/order/query", request);
/// </code>
/// </example>
public static YopResponse Post(string methodOrUri, YopRequest request)
{
    // 实现
}
```

#### 1.2 类注释
```csharp
/// <summary>
/// YOP客户端类，提供与易宝开放平台API交互的核心功能
/// 支持POST、GET、PUT等HTTP方法，以及签名验证和数据加密
/// </summary>
/// <remarks>
/// 此类是线程安全的，可以在多线程环境中使用
/// </remarks>
/// <example>
/// 以下示例展示如何使用YopClient进行API调用：
/// <code>
/// var client = new YopClient();
/// var request = new YopRequest();
/// request.AddParam("amount", "100.00");
/// var response = client.Post("rest/v1.0/payment/create", request);
/// </code>
/// </example>
public class YopClient
{
    // 实现
}
```

### 2. 代码注释

#### 2.1 实现注释
```csharp
public static string Sign(IDictionary<string, string> paramValues, 
    IList<string> ignoreParamNames, string secret, string algName)
{
    // 参数验证
    Assert.NotNull(paramValues, nameof(paramValues));
    Assert.NotNull(secret, nameof(secret));
    
    // 设置默认算法
    if (string.IsNullOrWhiteSpace(algName))
    {
        algName = YopConstants.ALG_SHA256;
    }
    
    // 构建签名字符串
    var signatureBuilder = new StringBuilder();
    signatureBuilder.Append(secret);
    
    // 按字母顺序排序参数
    var sortedKeys = paramValues.Keys
        .Except(ignoreParamNames ?? new List<string>())
        .OrderBy(key => key, StringComparer.Ordinal);
    
    foreach (var key in sortedKeys)
    {
        var value = paramValues[key];
        if (!string.IsNullOrWhiteSpace(value))
        {
            signatureBuilder.Append(key).Append(value);
        }
    }
    
    signatureBuilder.Append(secret);
    
    // 生成签名
    return Digest.Digest(signatureBuilder.ToString(), algName);
}
```

#### 2.2 TODO和FIXME
```csharp
// TODO: 2024-01-17 - 需要重构此方法，提高性能
public string LegacyMethod()
{
    // 临时实现
}

// FIXME: 处理边界情况时可能出现异常
public void ProcessData(string input)
{
    // 需要修复的代码
}
```

## 错误处理规范

### 1. 异常处理

#### 1.1 异常定义
```csharp
/// <summary>
/// YOP服务异常，表示API调用失败
/// </summary>
public class YopServiceException : YopClientException
{
    /// <summary>
    /// 错误码
    /// </summary>
    public string ErrorCode { get; }
    
    /// <summary>
    /// 错误消息
    /// </summary>
    public string ErrorMessage { get; }
    
    /// <summary>
    /// HTTP状态码
    /// </summary>
    public int StatusCode { get; }
    
    public YopServiceException(string errorCode, string errorMessage, int statusCode)
        : base($"{errorMessage} (Error Code: {errorCode}, Status Code: {statusCode})")
    {
        ErrorCode = errorCode;
        ErrorMessage = errorMessage;
        StatusCode = statusCode;
    }
}
```

#### 1.2 异常处理模式
```csharp
public YopResponse Post(string methodOrUri, YopRequest request)
{
    try
    {
        ValidateRequest(request);
        
        var response = ExecuteRequest(methodOrUri, request);
        ProcessResponse(response);
        
        return response;
    }
    catch (HttpRequestException ex)
    {
        throw new YopServiceException("NETWORK_ERROR", 
            "网络请求失败: " + ex.Message, 500);
    }
    catch (Exception ex)
    {
        // 记录异常日志
        Logger.Error($"API调用失败: {methodOrUri}", ex);
        throw;
    }
}
```

### 2. 参数验证

#### 2.1 验证方法
```csharp
public class Assert
{
    public static void NotNull(object value, string paramName)
    {
        if (value == null)
        {
            throw new ArgumentNullException(paramName);
        }
    }
    
    public static void NotNullOrEmpty(string value, string paramName)
    {
        if (string.IsNullOrEmpty(value))
        {
            throw new ArgumentException($"{paramName}不能为空或null", paramName);
        }
    }
    
    public static void IsValidUrl(string url, string paramName)
    {
        if (!Uri.TryCreate(url, UriKind.Absolute, out _))
        {
            throw new ArgumentException($"{paramName}必须是有效的URL", paramName);
        }
    }
}
```

## 代码质量规范

### 1. 性能优化

#### 1.1 字符串处理
```csharp
// 使用StringBuilder处理大量字符串拼接
var builder = new StringBuilder();
foreach (var item in items)
{
    builder.AppendLine(item.ToString());
}
var result = builder.ToString();

// 使用字符串插值替代string.Format
var message = $"处理订单 {orderId} 时发生错误: {error.Message}";
```

#### 1.2 集合操作
```csharp
// 使用LINQ进行集合操作
var activeUsers = users
    .Where(u => u.IsActive)
    .OrderBy(u => u.Name)
    .ToList();

// 避免在循环中重复计算
var count = items.Count;
for (int i = 0; i < count; i++)
{
    ProcessItem(items[i]);
}
```

### 2. 内存管理

#### 2.1 资源释放
```csharp
// 使用using语句确保资源释放
using var httpClient = new HttpClient();
using var response = await httpClient.GetAsync(url);

// 实现IDisposable接口
public class Encryptor : IDisposable
{
    private readonly IDisposable _resource;
    
    public Encryptor()
    {
        _resource = CreateResource();
    }
    
    public void Dispose()
    {
        _resource?.Dispose();
    }
}
```

### 3. 线程安全

#### 3.1 静态成员
```csharp
public class YopConfig
{
    private static readonly object _lock = new object();
    private static string _appKey;
    
    public static string AppKey
    {
        get
        {
            lock (_lock)
            {
                return _appKey;
            }
        }
        set
        {
            lock (_lock)
            {
                _appKey = value;
            }
        }
    }
}
```

## 工具和配置

### 1. EditorConfig

创建`.editorconfig`文件：
```ini
root = true

[*]
charset = utf-8
end_of_line = crlf
insert_final_newline = true
trim_trailing_whitespace = true

[*.cs]
indent_style = space
indent_size = 4

[*.{cs,vb}]
# New line preferences
csharp_new_line_before_open_brace = all
csharp_new_line_before_else = true
csharp_new_line_before_catch = true
csharp_new_line_before_finally = true
csharp_new_line_before_members_in_object_initializers = true
csharp_new_line_before_members_in_anonymous_types = true

# Space preferences
csharp_space_after_cast = false
csharp_space_after_keywords_in_control_flow_statements = true
csharp_space_between_method_call_parameter_list_parentheses = false
csharp_space_between_method_declaration_parameter_list_parentheses = false

# Wrapping preferences
csharp_preserve_single_line_statements = true
csharp_preserve_single_line_blocks = true
```

### 2. 代码分析规则

创建`.editorconfig`或`Directory.Build.props`：
```xml
<Project>
  <PropertyGroup>
    <EnableNETAnalyzers>true</EnableNETAnalyzers>
    <AnalysisLevel>latest</AnalysisLevel>
    <EnforceCodeStyleInBuild>true</EnforceCodeStyleInBuild>
    <RunAnalyzersDuringBuild>true</RunAnalyzersDuringBuild>
  </PropertyGroup>
</Project>
```

## 实施计划

### 阶段一：基础规范（1-2天）
1. 配置EditorConfig
2. 统一代码格式
3. 添加基础注释

### 阶段二：文档完善（2-3天）
1. 添加XML文档注释
2. 完善README文档
3. 创建使用示例

### 阶段三：质量提升（2-3天）
1. 优化性能瓶颈
2. 完善错误处理
3. 增强线程安全

### 阶段四：工具集成（1天）
1. 集成代码分析工具
2. 配置CI/CD检查
3. 建立代码审查流程

## 检查清单

### 代码审查检查项
- [ ] 命名符合规范
- [ ] 方法长度适中（<50行）
- [ ] 类职责单一
- [ ] 异常处理恰当
- [ ] 性能考虑合理
- [ ] 文档注释完整
- [ ] 无硬编码常量
- [ ] 资源正确释放
- [ ] 线程安全考虑

### 自动化检查
- [ ] 代码格式检查
- [ ] 命名规范检查
- [ ] 文档完整性检查
- [ ] 性能分析
- [ ] 安全漏洞扫描

## 持续改进

1. **定期审查**：每月进行代码质量审查
2. **培训分享**：定期进行最佳实践分享
3. **工具更新**：跟进最新开发工具和规范
4. **反馈收集**：收集团队反馈，持续优化规范

通过以上规范的实施，可以显著提升YOP .NET SDK的代码质量和维护性，为用户提供更好的开发体验。